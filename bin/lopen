#!/usr/bin/env bash
# shellcheck source=../lib/functions.inc.sh
source "$(dirname "$0")"/../lib/functions.inc

### END FRONTMATTER ###
set -e

LOPEN_CONFIG_DIR="${LOPEN_CONFIG_DIR:-${XDG_CONFIG_HOME}/lopen}"
LOPEN_MAILCAP_FILE="${LOPEN_MAILCAP_FILE:-${LOPEN_CONFIG_DIR}/mailcap}"
LOPEN_SHOW_COMMAND=false
LOPEN_SHOW_MIMETYPE=false
LOPEN_DRY=false

help() {
  echo "$(basename "$0") [options] <file>"
  echo "  -c   show command"
  echo "  -h   help"
  echo "  -m   show mimetype"
  echo "  -n   dry run"
  echo "  -v   verbose"
  echo
  echo "LOPEN_CONFIG_DIR: ${LOPEN_CONFIG_DIR}"
}

if [[ $# -gt 1 ]]; then
  f=${!#}
  a=$(echo -- "${@%$f}" | tr -d "[:blank:]-")
else
  if [[ ${!#} =~ ^- ]]; then
    a=$1
  else
    f=$1
  fi
fi

[[ $a =~ [h] ]]  && help && exit 0
[[ $a =~ [mv] ]] && LOPEN_SHOW_MIMETYPE=true
[[ $a =~ [cv] ]] && LOPEN_SHOW_COMMAND=true
[[ $a =~ [n] ]]  && LOPEN_DRY=true

input_type=$(input_type "$f")
mimetype=$(mimetype "$f")
mailcap_cmd=$(mailcap_cmd "$mimetype")
cmd=$(cmd "$f")

${LOPEN_SHOW_COMMAND} && echo "command:	${cmd}"
if [[ "${input_type}" == "file" ]]; then
  ${LOPEN_SHOW_COMMAND} && echo "mailcap:	${mailcap_cmd}"
  ${LOPEN_SHOW_MIMETYPE} && echo "mimetype:	${mimetype}"
fi

if ! ${LOPEN_DRY}; then
  case "${input_type}" in
    file) open_file "$f" ;;
    *)    open_url "$f" ;;
  esac
fi
