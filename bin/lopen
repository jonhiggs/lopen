#!/usr/bin/env bash
# shellcheck source=../lib/functions.inc.sh
source "$(dirname "$0")"/../lib/functions.inc
VERSION="[dev]"

### END FRONTMATTER ###
set -e

LOPEN_CONFIG_DIR="${LOPEN_CONFIG_DIR:-${XDG_CONFIG_HOME}/lopen}"
LOPEN_CONFIG="${LOPEN_CONFIG_DIR}/config"
LOPEN_FILETYPES="${LOPEN_CONFIG_DIR}/filetypes"
LOPEN_BROWSER="${LOPEN_BROWSER:-${BROWSER}}"
LOPEN_PAGER="${LOPEN_PAGER:-${PAGER:-less}}"
LOPEN_DRY=false
LOPEN_MAILCAP_FILE="${LOPEN_MAILCAP_FILE:-${LOPEN_CONFIG_DIR}/mailcap}"
LOPEN_SCHEMES=(http https ftp)
LOPEN_SHOW_COMMAND=false
LOPEN_SHOW_MIMETYPE=false

[[ -f ${LOPEN_CONFIG} ]] && source "${LOPEN_CONFIG}"

help() {
  echo "$(basename "$0") [options] <file>"
  echo "  -C   dump configuration"
  echo "  -c   show command"
  echo "  -h   help"
  echo "  -m   show mimetype"
  echo "  -n   dry run"
  echo "  -v   verbose"
  echo "  -V   version"
}

version() {
  echo "lopen version ${VERSION}"
}

if [[ $# -gt 1 ]]; then
  f=${!#}
  a=$(echo -- "${@%$f}" | tr -d "[:blank:]-")
else
  if [[ ${!#} =~ ^- ]]; then
    a=$1
  else
    f=$1
  fi
fi

[[ $a =~ [h] ]]  && help && exit 0
[[ $a =~ [V] ]]  && version && exit 0
[[ $a =~ [mv] ]] && LOPEN_SHOW_MIMETYPE=true
[[ $a =~ [cv] ]] && LOPEN_SHOW_COMMAND=true
[[ $a =~ [n] ]]  && LOPEN_DRY=true

[[ $a =~ [C] ]]  && dump_config && exit 0

input_type=$(input_type "$f")
mimetype=$(mimetype "$f")
mailcap_cmd=$(mailcap_cmd "$mimetype")
cmd=$(cmd "$f")

${LOPEN_SHOW_COMMAND} && echo "command:	${cmd}"
if [[ "${input_type}" == "file" ]]; then
  ${LOPEN_SHOW_COMMAND} && echo "mailcap:	${mailcap_cmd}"
  ${LOPEN_SHOW_MIMETYPE} && echo "mimetype:	${mimetype}"
fi

if ! ${LOPEN_DRY}; then
  bash -c "$(cmd "$f")"
else
  true
fi
